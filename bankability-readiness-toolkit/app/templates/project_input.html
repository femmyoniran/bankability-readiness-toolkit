{% extends "base.html" %}
{% block title %}New Assessment - Bankability Toolkit{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Project Assessment Input</h1>
    <p>Enter project parameters across all sections below. All fields with default values
       can be adjusted as needed. Required fields are marked.</p>
</div>

<form method="POST" action="{{ url_for('project.submit_project') }}" id="projectForm">
    <!-- Project Information -->
    <div class="form-section">
        <h2 class="section-heading">Project Information</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="project_name">Project Name *</label>
                <input type="text" id="project_name" name="project_name" required placeholder="e.g., Prairie Sun Solar Farm">
            </div>
            <div class="form-group">
                <label for="project_id">Project ID</label>
                <input type="text" id="project_id" name="project_id" placeholder="e.g., PSS-2026-001">
            </div>
            <div class="form-group">
                <label for="project_stage">Development Stage</label>
                <select id="project_stage" name="project_stage">
                    {% for stage in project_stages %}
                    <option value="{{ stage }}">{{ stage.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="entity_type">Entity Type</label>
                <select id="entity_type" name="entity_type">
                    {% for et in entity_types %}
                    <option value="{{ et }}">{{ et.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="location_state">State</label>
                <input type="text" id="location_state" name="location_state" placeholder="e.g., Kansas">
            </div>
            <div class="form-group">
                <label for="location_county">County</label>
                <input type="text" id="location_county" name="location_county" placeholder="e.g., Ford">
            </div>
            <div class="form-group">
                <label for="is_rural">
                    <input type="checkbox" id="is_rural" name="is_rural" value="true">
                    Rural Area (USDA Designation)
                </label>
            </div>
            <div class="form-group">
                <label for="cod_target">Target COD</label>
                <input type="text" id="cod_target" name="cod_target" placeholder="e.g., 2028-Q2">
            </div>
            <div class="form-group form-group-wide">
                <label for="description">Project Description</label>
                <textarea id="description" name="description" rows="3"
                    placeholder="Brief description of the project scope and purpose."></textarea>
            </div>
        </div>
    </div>

    <!-- Technical Parameters -->
    <div class="form-section">
        <h2 class="section-heading">Technical Parameters</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="technology_type">Technology Type *</label>
                <select id="technology_type" name="technology_type">
                    {% for tt in technology_types %}
                    <option value="{{ tt }}">{{ tt.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="nameplate_capacity_mw">Nameplate Capacity (MW) *</label>
                <input type="number" id="nameplate_capacity_mw" name="nameplate_capacity_mw" step="0.1" min="0" required>
            </div>
            <div class="form-group">
                <label for="annual_generation_mwh">Annual Generation (MWh)</label>
                <input type="number" id="annual_generation_mwh" name="annual_generation_mwh" step="1" min="0">
            </div>
            <div class="form-group">
                <label for="capacity_factor">Capacity Factor (0-1)</label>
                <input type="number" id="capacity_factor" name="capacity_factor" step="0.01" min="0" max="1" value="0.25">
            </div>
            <div class="form-group">
                <label for="technology_readiness_level">Technology Readiness Level (1-9)</label>
                <input type="number" id="technology_readiness_level" name="technology_readiness_level" min="1" max="9" value="9">
            </div>
            <div class="form-group">
                <label for="expected_useful_life_years">Useful Life (years)</label>
                <input type="number" id="expected_useful_life_years" name="expected_useful_life_years" min="1" max="50" value="30">
            </div>
            <div class="form-group">
                <label for="degradation_rate_annual">Annual Degradation Rate</label>
                <input type="number" id="degradation_rate_annual" name="degradation_rate_annual" step="0.001" min="0" max="0.1" value="0.005">
            </div>
            <div class="form-group">
                <label for="availability_factor">Availability Factor</label>
                <input type="number" id="availability_factor" name="availability_factor" step="0.01" min="0" max="1" value="0.98">
            </div>
            <div class="form-group">
                <label for="interconnection_voltage_kv">Interconnection Voltage (kV)</label>
                <input type="number" id="interconnection_voltage_kv" name="interconnection_voltage_kv" step="1" min="0">
            </div>
            <div class="form-group">
                <label for="interconnection_status">Interconnection Status</label>
                <select id="interconnection_status" name="interconnection_status">
                    <option value="planned">Planned</option>
                    <option value="study_in_progress">Study in Progress</option>
                    <option value="study_complete">Study Complete</option>
                    <option value="agreement_executed">Agreement Executed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="environmental_permits_secured">
                    <input type="checkbox" id="environmental_permits_secured" name="environmental_permits_secured" value="true">
                    Environmental Permits Secured
                </label>
            </div>
            <div class="form-group">
                <label for="site_control_secured">
                    <input type="checkbox" id="site_control_secured" name="site_control_secured" value="true">
                    Site Control Secured
                </label>
            </div>
        </div>
    </div>

    <!-- Financial Parameters -->
    <div class="form-section">
        <h2 class="section-heading">Financial Parameters</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="total_project_cost">Total Project Cost ($) *</label>
                <input type="number" id="total_project_cost" name="total_project_cost" step="1" min="0" required>
            </div>
            <div class="form-group">
                <label for="total_hard_costs">Hard Costs ($)</label>
                <input type="number" id="total_hard_costs" name="total_hard_costs" step="1" min="0">
            </div>
            <div class="form-group">
                <label for="total_soft_costs">Soft Costs ($)</label>
                <input type="number" id="total_soft_costs" name="total_soft_costs" step="1" min="0">
            </div>
            <div class="form-group">
                <label for="contingency_percent">Contingency (%)</label>
                <input type="number" id="contingency_percent" name="contingency_percent" step="0.01" min="0" max="0.30" value="0.10">
            </div>
            <div class="form-group">
                <label for="construction_period_months">Construction Period (months)</label>
                <input type="number" id="construction_period_months" name="construction_period_months" min="1" max="120" value="24">
            </div>
            <div class="form-group">
                <label for="debt_percent">Debt % (0-1)</label>
                <input type="number" id="debt_percent" name="debt_percent" step="0.01" min="0" max="1" value="0.70">
            </div>
            <div class="form-group">
                <label for="equity_percent">Equity % (0-1)</label>
                <input type="number" id="equity_percent" name="equity_percent" step="0.01" min="0" max="1" value="0.30">
            </div>
            <div class="form-group">
                <label for="interest_rate">Interest Rate (decimal)</label>
                <input type="number" id="interest_rate" name="interest_rate" step="0.001" min="0" max="0.30" value="0.055">
            </div>
            <div class="form-group">
                <label for="debt_tenor_years">Debt Tenor (years)</label>
                <input type="number" id="debt_tenor_years" name="debt_tenor_years" min="1" max="40" value="20">
            </div>
            <div class="form-group">
                <label for="target_dscr">Target DSCR</label>
                <input type="number" id="target_dscr" name="target_dscr" step="0.01" min="1" max="3" value="1.40">
            </div>
            <div class="form-group">
                <label for="annual_revenue">Annual Revenue ($) *</label>
                <input type="number" id="annual_revenue" name="annual_revenue" step="1" min="0" required>
            </div>
            <div class="form-group">
                <label for="annual_opex">Annual Operating Expenses ($)</label>
                <input type="number" id="annual_opex" name="annual_opex" step="1" min="0">
            </div>
            <div class="form-group">
                <label for="annual_opex_escalation">OpEx Escalation Rate</label>
                <input type="number" id="annual_opex_escalation" name="annual_opex_escalation" step="0.001" min="0" max="0.10" value="0.025">
            </div>
            <div class="form-group">
                <label for="revenue_escalation">Revenue Escalation Rate</label>
                <input type="number" id="revenue_escalation" name="revenue_escalation" step="0.001" min="0" max="0.10" value="0.02">
            </div>
            <div class="form-group">
                <label for="tax_rate">Tax Rate</label>
                <input type="number" id="tax_rate" name="tax_rate" step="0.01" min="0" max="0.50" value="0.21">
            </div>
            <div class="form-group">
                <label for="itc_percent">ITC (%) -- 0 if none</label>
                <input type="number" id="itc_percent" name="itc_percent" step="0.01" min="0" max="0.50" value="0">
            </div>
            <div class="form-group">
                <label for="ptc_per_mwh">PTC ($/MWh) -- 0 if none</label>
                <input type="number" id="ptc_per_mwh" name="ptc_per_mwh" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="depreciation_schedule">Depreciation Schedule</label>
                <select id="depreciation_schedule" name="depreciation_schedule">
                    <option value="macrs_5">MACRS 5-Year</option>
                    <option value="macrs_7">MACRS 7-Year</option>
                    <option value="straight_line">Straight Line</option>
                </select>
            </div>
            <div class="form-group">
                <label for="discount_rate">Discount Rate</label>
                <input type="number" id="discount_rate" name="discount_rate" step="0.001" min="0" max="0.30" value="0.08">
            </div>
        </div>
    </div>

    <!-- Credit Parameters -->
    <div class="form-section">
        <h2 class="section-heading">Credit &amp; Offtake</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="offtake_type">Offtake Type</label>
                <select id="offtake_type" name="offtake_type">
                    {% for ot in offtake_types %}
                    <option value="{{ ot }}">{{ ot.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="offtake_tenor_years">Offtake Tenor (years)</label>
                <input type="number" id="offtake_tenor_years" name="offtake_tenor_years" min="0" max="40" value="20">
            </div>
            <div class="form-group">
                <label for="offtaker_credit_rating">Offtaker Credit Rating</label>
                <select id="offtaker_credit_rating" name="offtaker_credit_rating">
                    <option value="AAA">AAA</option>
                    <option value="AA+">AA+</option>
                    <option value="AA">AA</option>
                    <option value="AA-">AA-</option>
                    <option value="A+">A+</option>
                    <option value="A">A</option>
                    <option value="A-">A-</option>
                    <option value="BBB+" selected>BBB+</option>
                    <option value="BBB">BBB</option>
                    <option value="BBB-">BBB-</option>
                    <option value="BB+">BB+</option>
                    <option value="BB">BB</option>
                    <option value="BB-">BB-</option>
                    <option value="B+">B+</option>
                    <option value="B">B</option>
                    <option value="B-">B-</option>
                    <option value="unrated">Unrated</option>
                </select>
            </div>
            <div class="form-group">
                <label for="offtaker_entity_type">Offtaker Entity Type</label>
                <select id="offtaker_entity_type" name="offtaker_entity_type">
                    {% for et in entity_types %}
                    <option value="{{ et }}">{{ et.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="revenue_concentration_percent">Revenue Concentration (0-1)</label>
                <input type="number" id="revenue_concentration_percent" name="revenue_concentration_percent" step="0.01" min="0" max="1" value="1.0">
            </div>
            <div class="form-group">
                <label for="regulatory_stability_rating">Regulatory Stability</label>
                <select id="regulatory_stability_rating" name="regulatory_stability_rating">
                    <option value="stable" selected>Stable</option>
                    <option value="positive">Positive</option>
                    <option value="uncertain">Uncertain</option>
                    <option value="negative">Negative</option>
                </select>
            </div>
            <div class="form-group">
                <label for="counterparty_count">Number of Counterparties</label>
                <input type="number" id="counterparty_count" name="counterparty_count" min="1" max="50" value="1">
            </div>
            <div class="form-group">
                <label for="contract_price_per_mwh">Contract Price ($/MWh)</label>
                <input type="number" id="contract_price_per_mwh" name="contract_price_per_mwh" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="has_credit_support">
                    <input type="checkbox" id="has_credit_support" name="has_credit_support" value="true">
                    Credit Support (LC, Guarantee, etc.)
                </label>
            </div>
            <div class="form-group">
                <label for="credit_support_type">Credit Support Type</label>
                <input type="text" id="credit_support_type" name="credit_support_type" placeholder="e.g., letter_of_credit">
            </div>
        </div>
    </div>

    <!-- Structure Parameters -->
    <div class="form-section">
        <h2 class="section-heading">Project Structure</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="epc_contract_type">EPC Contract Type</label>
                <select id="epc_contract_type" name="epc_contract_type">
                    <option value="fixed_price_turnkey" selected>Fixed Price Turnkey</option>
                    <option value="fixed_price_epc">Fixed Price EPC</option>
                    <option value="cost_plus_gmp">Cost Plus GMP</option>
                    <option value="cost_plus">Cost Plus</option>
                    <option value="self_build">Self Build</option>
                </select>
            </div>
            <div class="form-group">
                <label for="epc_contractor_experience">EPC Contractor Experience</label>
                <select id="epc_contractor_experience" name="epc_contractor_experience">
                    <option value="established" selected>Established</option>
                    <option value="experienced">Experienced</option>
                    <option value="moderate">Moderate</option>
                    <option value="limited">Limited</option>
                </select>
            </div>
            <div class="form-group">
                <label for="insurance_coverage">Insurance Coverage</label>
                <select id="insurance_coverage" name="insurance_coverage">
                    <option value="comprehensive" selected>Comprehensive</option>
                    <option value="standard">Standard</option>
                    <option value="basic">Basic</option>
                    <option value="none">None</option>
                </select>
            </div>
            <div class="form-group">
                <label for="om_contract_type">O&amp;M Contract Type</label>
                <select id="om_contract_type" name="om_contract_type">
                    <option value="full_service" selected>Full Service</option>
                    <option value="limited_service">Limited Service</option>
                    <option value="self_performed">Self Performed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="om_contract_tenor_years">O&amp;M Contract Tenor (years)</label>
                <input type="number" id="om_contract_tenor_years" name="om_contract_tenor_years" min="0" max="30" value="10">
            </div>
            <div class="form-group">
                <label for="performance_guarantee_level">Performance Guarantee Level (0-1)</label>
                <input type="number" id="performance_guarantee_level" name="performance_guarantee_level" step="0.01" min="0" max="1" value="0.95">
            </div>
            <div class="form-group">
                <label for="debt_service_reserve_months">DSRA Months</label>
                <input type="number" id="debt_service_reserve_months" name="debt_service_reserve_months" min="0" max="18" value="6">
            </div>
            <div class="form-group form-checkbox-group">
                <label><input type="checkbox" name="performance_guarantee" value="true" checked> Performance Guarantee</label>
                <label><input type="checkbox" name="completion_guarantee" value="true" checked> Completion Guarantee</label>
                <label><input type="checkbox" name="reserve_accounts_funded" value="true"> Reserves Funded</label>
                <label><input type="checkbox" name="major_maintenance_reserve" value="true"> Major Maintenance Reserve</label>
                <label><input type="checkbox" name="step_in_rights" value="true" checked> Step-in Rights</label>
                <label><input type="checkbox" name="assignment_provisions" value="true" checked> Assignment Provisions</label>
                <label><input type="checkbox" name="change_of_control_provisions" value="true" checked> Change of Control Provisions</label>
            </div>
        </div>
    </div>

    <!-- Market Parameters -->
    <div class="form-section">
        <h2 class="section-heading">Market &amp; Resource</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="resource_quality">Resource Quality</label>
                <select id="resource_quality" name="resource_quality">
                    <option value="excellent">Excellent</option>
                    <option value="good" selected>Good</option>
                    <option value="average">Average</option>
                    <option value="below_average">Below Average</option>
                    <option value="poor">Poor</option>
                </select>
            </div>
            <div class="form-group">
                <label for="resource_assessment_confidence">Resource Assessment Confidence</label>
                <select id="resource_assessment_confidence" name="resource_assessment_confidence">
                    <option value="p99">P99</option>
                    <option value="p90">P90</option>
                    <option value="p75">P75</option>
                    <option value="p50" selected>P50</option>
                </select>
            </div>
            <div class="form-group">
                <label for="interconnection_certainty">Interconnection Certainty</label>
                <select id="interconnection_certainty" name="interconnection_certainty">
                    <option value="secured">Secured</option>
                    <option value="high" selected>High</option>
                    <option value="moderate">Moderate</option>
                    <option value="low">Low</option>
                    <option value="speculative">Speculative</option>
                </select>
            </div>
            <div class="form-group">
                <label for="grid_congestion_risk">Grid Congestion Risk</label>
                <select id="grid_congestion_risk" name="grid_congestion_risk">
                    <option value="none">None</option>
                    <option value="low" selected>Low</option>
                    <option value="moderate">Moderate</option>
                    <option value="high">High</option>
                    <option value="severe">Severe</option>
                </select>
            </div>
            <div class="form-group">
                <label for="market_price_per_mwh">Market Price ($/MWh)</label>
                <input type="number" id="market_price_per_mwh" name="market_price_per_mwh" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="curtailment_history_percent">Curtailment History (0-1)</label>
                <input type="number" id="curtailment_history_percent" name="curtailment_history_percent" step="0.01" min="0" max="1" value="0">
            </div>
            <div class="form-group">
                <label for="competing_projects_in_queue">Projects in Queue</label>
                <input type="number" id="competing_projects_in_queue" name="competing_projects_in_queue" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="land_lease_term_years">Land Lease Term (years)</label>
                <input type="number" id="land_lease_term_years" name="land_lease_term_years" min="0" max="99" value="30">
            </div>
            <div class="form-group">
                <label for="community_support">Community Support</label>
                <select id="community_support" name="community_support">
                    <option value="supportive" selected>Supportive</option>
                    <option value="neutral">Neutral</option>
                    <option value="mixed">Mixed</option>
                    <option value="opposed">Opposed</option>
                </select>
            </div>
            <div class="form-group form-checkbox-group">
                <label><input type="checkbox" name="independent_resource_assessment" value="true"> Independent Resource Assessment</label>
                <label><input type="checkbox" name="land_lease_secured" value="true"> Land Lease Secured</label>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-lg">Run Bankability Assessment</button>
        <button type="reset" class="btn btn-secondary">Reset Form</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/forms.js') }}"></script>
{% endblock %}
