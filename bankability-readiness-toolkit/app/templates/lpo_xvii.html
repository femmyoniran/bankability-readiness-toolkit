{% extends "base.html" %}
{% block title %}DOE LPO Title XVII Application - {{ app_data.part_i.project_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>U.S. Department of Energy</h1>
    <h2>Loan Programs Office &mdash; Title XVII</h2>
    <p class="form-subtitle">Innovative Clean Energy Loan Guarantee Application</p>
</div>

{% if not app_data %}
<div class="alert alert-warning">
    <p>No project data available to generate the application. Please <a href="{{ url_for('project.new_project') }}">create a project</a> first.</p>
</div>
{% else %}

<div class="form-notice">
    <p><strong>Notice:</strong> This document is a pre-populated draft generated from the project assessment data.
       It is not a submission-ready application. All fields must be reviewed, verified, and supplemented with actual
       documentation before submission to the Loan Programs Office. This draft covers the key data elements of the
       Part I (Pre-Application) and Part II (Full Application) processes.</p>
</div>

<!-- PART I: PRE-APPLICATION -->
<div class="lpo-part">
    <h2 class="lpo-part-header">Part I: Pre-Application</h2>

    <section class="form-section">
        <h3>1. Project Summary</h3>
        <table class="data-table form-table">
            <tr><td>Project Name</td><td>{{ app_data.part_i.project_name }}</td></tr>
            <tr><td>Applicant / Sponsor</td><td>{{ app_data.part_i.applicant }}</td></tr>
            <tr><td>Project Location</td><td>{{ app_data.part_i.location }}</td></tr>
            <tr><td>Technology Category</td><td>{{ app_data.part_i.technology_category }}</td></tr>
            <tr><td>Technology Type</td><td>{{ app_data.part_i.technology_type }}</td></tr>
            <tr><td>Capacity</td><td>{{ app_data.part_i.capacity_mw }} MW</td></tr>
            <tr><td>Estimated Total Project Cost</td><td>${{ "{:,.0f}".format(app_data.part_i.total_project_cost) }}</td></tr>
            <tr><td>Loan Guarantee Amount Requested</td><td>${{ "{:,.0f}".format(app_data.part_i.guarantee_amount_requested) }}</td></tr>
            <tr><td>Anticipated COD</td><td>{{ app_data.part_i.target_cod }}</td></tr>
            <tr><td>Jobs Created (Construction)</td><td>{{ app_data.part_i.jobs_construction }}</td></tr>
            <tr><td>Jobs Created (Operations)</td><td>{{ app_data.part_i.jobs_operations }}</td></tr>
        </table>
    </section>

    <section class="form-section">
        <h3>2. Eligible Project Category</h3>
        <table class="data-table form-table">
            <tr><td>Requested Category</td><td>{{ app_data.part_i.eligible_category }}</td></tr>
            <tr><td>Statutory Authority</td><td>{{ app_data.part_i.statutory_authority }}</td></tr>
        </table>
        {% if app_data.part_i.innovation_narrative %}
        <div class="form-narrative">
            <h4>Innovation Narrative</h4>
            <p>{{ app_data.part_i.innovation_narrative }}</p>
        </div>
        {% endif %}
    </section>

    <section class="form-section">
        <h3>3. Preliminary Financial Overview</h3>
        <table class="data-table form-table">
            <tr><td>Debt / Equity Split</td><td>{{ app_data.part_i.debt_equity_split }}</td></tr>
            <tr><td>Projected Project IRR</td><td>{{ app_data.part_i.project_irr }}%</td></tr>
            <tr><td>Projected DSCR (Min)</td><td>{{ app_data.part_i.dscr_min }}x</td></tr>
            <tr><td>Projected LCOE</td><td>${{ app_data.part_i.lcoe }}/MWh</td></tr>
            <tr><td>Offtake Arrangement</td><td>{{ app_data.part_i.offtake_summary }}</td></tr>
            <tr><td>Equity Sponsor(s)</td><td>{{ app_data.part_i.equity_sponsors }}</td></tr>
        </table>
    </section>

    {% if app_data.part_i.credit_subsidy %}
    <section class="form-section">
        <h3>4. Credit Subsidy Estimate</h3>
        <table class="data-table form-table">
            <tr><td>Estimated Credit Subsidy Cost</td><td>${{ "{:,.0f}".format(app_data.part_i.credit_subsidy.estimated_cost) }}</td></tr>
            <tr><td>Subsidy Rate (%)</td><td>{{ app_data.part_i.credit_subsidy.subsidy_rate }}%</td></tr>
            <tr><td>Guarantee Amount</td><td>${{ "{:,.0f}".format(app_data.part_i.credit_subsidy.guarantee_amount) }}</td></tr>
        </table>
        <p class="note">{{ app_data.part_i.credit_subsidy.note }}</p>
    </section>
    {% endif %}
</div>

<!-- PART II: FULL APPLICATION -->
<div class="lpo-part">
    <h2 class="lpo-part-header">Part II: Full Application</h2>

    <section class="form-section">
        <h3>5. Detailed Project Description</h3>
        <table class="data-table form-table">
            {% for key, val in app_data.part_ii.project_details.items() %}
            <tr>
                <td>{{ key|replace('_', ' ')|title }}</td>
                <td>
                    {% if val is mapping %}
                        {% for k2, v2 in val.items() %}
                        {{ k2 }}: {{ v2 }}<br>
                        {% endfor %}
                    {% elif val is iterable and val is not string %}
                        <ul class="inline-list">
                            {% for item in val %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {{ val }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </section>

    <section class="form-section">
        <h3>6. Financial Plan</h3>
        <table class="data-table form-table">
            {% for key, val in app_data.part_ii.financial_plan.items() %}
            <tr>
                <td>{{ key|replace('_', ' ')|title }}</td>
                <td>
                    {% if val is number %}
                        {% if val > 1000 %}${{ "{:,.0f}".format(val) }}{% else %}{{ val }}{% endif %}
                    {% else %}
                        {{ val }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </section>

    {% if app_data.part_ii.environmental %}
    <section class="form-section">
        <h3>7. Environmental Review (NEPA)</h3>
        <table class="data-table form-table">
            {% for key, val in app_data.part_ii.environmental.items() %}
            <tr>
                <td>{{ key|replace('_', ' ')|title }}</td>
                <td>{{ val }}</td>
            </tr>
            {% endfor %}
        </table>
    </section>
    {% endif %}

    {% if app_data.part_ii.compliance %}
    <section class="form-section">
        <h3>8. Compliance Requirements</h3>
        <table class="data-table form-table">
            {% for req in app_data.part_ii.compliance %}
            <tr>
                <td>{{ req.requirement }}</td>
                <td>{{ req.status }}</td>
                <td>{{ req.detail }}</td>
            </tr>
            {% endfor %}
        </table>
    </section>
    {% endif %}

    {% if app_data.part_ii.fee_schedule %}
    <section class="form-section">
        <h3>9. Application Fee Schedule</h3>
        <table class="data-table form-table">
            {% for key, val in app_data.part_ii.fee_schedule.items() %}
            <tr>
                <td>{{ key|replace('_', ' ')|title }}</td>
                <td>
                    {% if val is number %}${{ "{:,.0f}".format(val) }}{% else %}{{ val }}{% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </section>
    {% endif %}
</div>

<!-- Eligibility Assessment -->
{% if app_data.eligibility_assessment %}
<section class="form-section">
    <h3>Eligibility Assessment Summary</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Criterion</th>
                <th>Status</th>
                <th>Detail</th>
            </tr>
        </thead>
        <tbody>
            {% for c in app_data.eligibility_assessment %}
            <tr>
                <td>{{ c.criterion }}</td>
                <td>
                    {% if c.met == true %}
                    <span class="status-positive">Met</span>
                    {% elif c.met == false %}
                    <span class="status-negative">Not Met</span>
                    {% else %}
                    <span class="status-neutral">{{ c.met }}</span>
                    {% endif %}
                </td>
                <td>{{ c.detail }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endif %}

{% endif %}

<section class="results-actions">
    <a href="{{ url_for('report.summary_report') }}" class="btn btn-secondary">Back to Report</a>
    <a href="{{ url_for('analysis.financing') }}" class="btn btn-secondary">Financing Structures</a>
    <a href="{{ url_for('report.export_json') }}" class="btn btn-secondary">Export JSON</a>
</section>
{% endblock %}
