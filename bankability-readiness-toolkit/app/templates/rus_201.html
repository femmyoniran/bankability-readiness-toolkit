{% extends "base.html" %}
{% block title %}USDA RUS Form 201 - {{ form_data.section_a.applicant_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>USDA Rural Utilities Service</h1>
    <h2>Form 201 &mdash; Borrower Information</h2>
    <p class="form-subtitle">Electric Loan and Loan Guarantee Application</p>
</div>

{% if not form_data %}
<div class="alert alert-warning">
    <p>No project data available to generate the form. Please <a href="{{ url_for('project.new_project') }}">create a project</a> first.</p>
</div>
{% else %}

<div class="form-notice">
    <p><strong>Notice:</strong> This document is a pre-populated draft generated from the project assessment data.
       It is not a submission-ready form. All fields must be reviewed, verified, and supplemented with actual
       documentation before submission to the Rural Utilities Service.</p>
</div>

<!-- Section A: Borrower Information -->
<section class="form-section">
    <h3>Section A: Applicant / Borrower Information</h3>
    <table class="data-table form-table">
        <tr><td>Applicant Legal Name</td><td>{{ form_data.section_a.applicant_name }}</td></tr>
        <tr><td>Applicant Type</td><td>{{ form_data.section_a.applicant_type }}</td></tr>
        <tr><td>State of Incorporation</td><td>{{ form_data.section_a.state }}</td></tr>
        <tr><td>Date of Incorporation</td><td>{{ form_data.section_a.date_incorporated }}</td></tr>
        <tr><td>Physical Address</td><td>{{ form_data.section_a.physical_address }}</td></tr>
        <tr><td>Mailing Address</td><td>{{ form_data.section_a.mailing_address }}</td></tr>
        <tr><td>Contact Name</td><td>{{ form_data.section_a.contact_name }}</td></tr>
        <tr><td>Phone</td><td>{{ form_data.section_a.phone }}</td></tr>
        <tr><td>Email</td><td>{{ form_data.section_a.email }}</td></tr>
        <tr><td>Existing RUS Borrower</td><td>{{ form_data.section_a.existing_borrower }}</td></tr>
        <tr><td>RUS Borrower Designation</td><td>{{ form_data.section_a.borrower_designation }}</td></tr>
        <tr><td>DUNS Number</td><td>{{ form_data.section_a.duns_number }}</td></tr>
    </table>
</section>

<!-- Section B: Loan Request -->
<section class="form-section">
    <h3>Section B: Loan Request</h3>
    <table class="data-table form-table">
        <tr><td>Type of Loan Requested</td><td>{{ form_data.section_b.loan_type }}</td></tr>
        <tr><td>Loan Amount Requested</td><td>${{ "{:,.0f}".format(form_data.section_b.loan_amount) }}</td></tr>
        <tr><td>Loan Purpose</td><td>{{ form_data.section_b.loan_purpose }}</td></tr>
        <tr><td>Requested Interest Rate Type</td><td>{{ form_data.section_b.interest_rate_type }}</td></tr>
        <tr><td>Requested Term</td><td>{{ form_data.section_b.term_years }} years</td></tr>
        <tr><td>Requested Amortization</td><td>{{ form_data.section_b.amortization_years }} years</td></tr>
        <tr><td>Anticipated First Advance</td><td>{{ form_data.section_b.first_advance_date }}</td></tr>
        <tr><td>Construction Period</td><td>{{ form_data.section_b.construction_period }}</td></tr>
    </table>
</section>

<!-- Section C: Project Description -->
<section class="form-section">
    <h3>Section C: Project Description</h3>
    <table class="data-table form-table">
        <tr><td>Project Name</td><td>{{ form_data.section_c.project_name }}</td></tr>
        <tr><td>Project Type</td><td>{{ form_data.section_c.project_type }}</td></tr>
        <tr><td>Technology</td><td>{{ form_data.section_c.technology }}</td></tr>
        <tr><td>Capacity (MW)</td><td>{{ form_data.section_c.capacity_mw }}</td></tr>
        <tr><td>Annual Generation (MWh)</td><td>{{ "{:,.0f}".format(form_data.section_c.annual_generation_mwh) }}</td></tr>
        <tr><td>Project Location</td><td>{{ form_data.section_c.location }}</td></tr>
        <tr><td>Rural Area Certification</td><td>{{ form_data.section_c.rural_area }}</td></tr>
        <tr><td>Consumers / Customers Served</td><td>{{ form_data.section_c.consumers_served }}</td></tr>
        <tr><td>Target COD</td><td>{{ form_data.section_c.target_cod }}</td></tr>
        <tr><td>Project Useful Life</td><td>{{ form_data.section_c.useful_life }} years</td></tr>
    </table>
    {% if form_data.section_c.narrative %}
    <div class="form-narrative">
        <h4>Project Narrative</h4>
        <p>{{ form_data.section_c.narrative }}</p>
    </div>
    {% endif %}
</section>

<!-- Section D: Cost Estimates -->
<section class="form-section">
    <h3>Section D: Estimated Project Cost</h3>
    <table class="data-table form-table">
        <thead>
            <tr>
                <th>Cost Category</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in form_data.section_d.cost_breakdown %}
            <tr>
                <td>{{ item.category }}</td>
                <td>${{ "{:,.0f}".format(item.amount) }}</td>
            </tr>
            {% endfor %}
            <tr class="table-total">
                <td><strong>Total Project Cost</strong></td>
                <td><strong>${{ "{:,.0f}".format(form_data.section_d.total_project_cost) }}</strong></td>
            </tr>
        </tbody>
    </table>
    <table class="data-table form-table" style="margin-top: 1rem;">
        <tr><td>Sources of Funds - Loan</td><td>${{ "{:,.0f}".format(form_data.section_d.sources.loan) }}</td></tr>
        <tr><td>Sources of Funds - Equity</td><td>${{ "{:,.0f}".format(form_data.section_d.sources.equity) }}</td></tr>
        {% if form_data.section_d.sources.other %}
        <tr><td>Sources of Funds - Other</td><td>${{ "{:,.0f}".format(form_data.section_d.sources.other) }}</td></tr>
        {% endif %}
    </table>
</section>

<!-- Section E: Financial Information -->
<section class="form-section">
    <h3>Section E: Financial Information</h3>
    <table class="data-table form-table">
        <tr><td>Current Equity / Net Worth</td><td>${{ "{:,.0f}".format(form_data.section_e.equity) }}</td></tr>
        <tr><td>Total Assets</td><td>${{ "{:,.0f}".format(form_data.section_e.total_assets) }}</td></tr>
        <tr><td>Total Liabilities</td><td>${{ "{:,.0f}".format(form_data.section_e.total_liabilities) }}</td></tr>
        <tr><td>Annual Revenue (most recent)</td><td>${{ "{:,.0f}".format(form_data.section_e.annual_revenue) }}</td></tr>
        <tr><td>Net Income (most recent)</td><td>${{ "{:,.0f}".format(form_data.section_e.net_income) }}</td></tr>
        <tr><td>Current Ratio</td><td>{{ form_data.section_e.current_ratio }}</td></tr>
        <tr><td>Debt-to-Equity Ratio</td><td>{{ form_data.section_e.debt_to_equity }}</td></tr>
        <tr><td>TIER</td><td>{{ form_data.section_e.tier }}</td></tr>
        <tr><td>DSC</td><td>{{ form_data.section_e.dsc }}</td></tr>
    </table>
</section>

<!-- Section F: Economic Feasibility -->
<section class="form-section">
    <h3>Section F: Economic Feasibility</h3>
    <table class="data-table form-table">
        <tr><td>Projected DSCR (Minimum)</td><td>{{ form_data.section_f.projected_dscr_min }}x</td></tr>
        <tr><td>Projected DSCR (Average)</td><td>{{ form_data.section_f.projected_dscr_avg }}x</td></tr>
        <tr><td>Project IRR</td><td>{{ form_data.section_f.project_irr }}%</td></tr>
        <tr><td>Levelized Cost of Energy</td><td>${{ form_data.section_f.lcoe }}/MWh</td></tr>
        <tr><td>Payback Period</td><td>{{ form_data.section_f.payback_years }} years</td></tr>
        <tr><td>NPV (at discount rate)</td><td>${{ "{:,.0f}".format(form_data.section_f.npv) }}</td></tr>
        <tr><td>Offtake Contract Type</td><td>{{ form_data.section_f.offtake_type }}</td></tr>
        <tr><td>Offtake Contract Term</td><td>{{ form_data.section_f.offtake_term }} years</td></tr>
        <tr><td>PPA / Contract Price</td><td>${{ form_data.section_f.contract_price }}/MWh</td></tr>
    </table>
</section>

<!-- Section G: Environmental Review -->
<section class="form-section">
    <h3>Section G: Environmental Review Information</h3>
    <table class="data-table form-table">
        {% for key, val in form_data.section_g.items() %}
        {% if val is string or val is number %}
        <tr>
            <td>{{ key|replace('_', ' ')|title }}</td>
            <td>{{ val }}</td>
        </tr>
        {% endif %}
        {% endfor %}
    </table>
</section>

<!-- Section H: Certifications -->
<section class="form-section">
    <h3>Section H: Certifications and Disclosures</h3>
    {% if form_data.section_h is mapping %}
    <table class="data-table form-table">
        {% for key, val in form_data.section_h.items() %}
        <tr>
            <td>{{ key|replace('_', ' ')|title }}</td>
            <td>{{ val }}</td>
        </tr>
        {% endfor %}
    </table>
    {% elif form_data.section_h is iterable %}
    <ul>
        {% for item in form_data.section_h %}
        <li>{{ item }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</section>

<!-- Required Attachments -->
{% if form_data.supporting_documents %}
<section class="form-section">
    <h3>Required Supporting Documents</h3>
    <ol class="document-checklist">
        {% for doc in form_data.supporting_documents %}
        <li>
            <span class="doc-name">{{ doc.document }}</span>
            <span class="doc-status">{{ doc.status }}</span>
        </li>
        {% endfor %}
    </ol>
</section>
{% endif %}

{% if form_data.eligibility_notes %}
<section class="form-section">
    <h3>Eligibility Notes</h3>
    <ul>
        {% for note in form_data.eligibility_notes %}
        <li>{{ note }}</li>
        {% endfor %}
    </ul>
</section>
{% endif %}

{% endif %}

<section class="results-actions">
    <a href="{{ url_for('report.summary_report') }}" class="btn btn-secondary">Back to Report</a>
    <a href="{{ url_for('analysis.financing') }}" class="btn btn-secondary">Financing Structures</a>
    <a href="{{ url_for('report.export_json') }}" class="btn btn-secondary">Export JSON</a>
</section>
{% endblock %}
